<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æŠ€è¡“è³‡æ–™ãƒŠãƒ¬ãƒƒã‚¸åŒ–</title>
    <link rel="stylesheet" href="style.css">
    
    <script>
        // Reserved for deployment script to inject API configuration
        // Do not edit manually
        window.API_CONFIG = window.API_CONFIG || {};
    </script>
    
    <!-- AWS SDK for Cognito -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1000.0.min.js"></script>
    
    <!-- Authentication Guard -->
    <script>
        // ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆã€èªè¨¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¯¾å¿œï¼‰
        (function() {
            async function checkAuthentication() {
                const accessToken = localStorage.getItem('cognito_access_token');
                if (!accessToken) {
                    // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã€index.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    console.warn('[knowledge-query.html] Not authenticated. Redirecting to index.html');
                    window.location.href = 'index.html';
                    return false;
                }
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’ç¢ºèª
                const expiresAt = localStorage.getItem('cognito_token_expires_at');
                if (expiresAt) {
                    const now = Date.now();
                    const expiryTime = parseInt(expiresAt, 10);
                    
                    if (now >= expiryTime) {
                        console.warn('[knowledge-query.html] Token expired. Attempting refresh...');
                        
                        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è©¦ã¿ã‚‹
                        const refreshToken = localStorage.getItem('cognito_refresh_token');
                        if (refreshToken) {
                            try {
                                // auth.jsã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…æ©Ÿã—ã¦ã‹ã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                                const authManager = await waitForAuthManager();
                                
                                if (authManager) {
                                    const refreshResult = await authManager.refreshAccessToken();
                                    if (refreshResult.success) {
                                        console.log('[knowledge-query.html] Token refreshed successfully, continuing...');
                                        return true;
                                    }
                                }
                            } catch (error) {
                                console.error('[knowledge-query.html] Token refresh failed:', error);
                            }
                        }
                        
                        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•— â†’ æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        console.warn('[knowledge-query.html] Token refresh failed. Redirecting to index.html');
                        localStorage.removeItem('cognito_access_token');
                        localStorage.removeItem('cognito_id_token');
                        localStorage.removeItem('cognito_token_expires_at');
                        window.location.href = 'index.html';
                        return false;
                    }
                }
                
                return true;
            }
            
            // AuthManagerã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…æ©Ÿï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
            function waitForAuthManager() {
                return new Promise((resolve) => {
                    if (window.knowledgeQueryAuthManager) {
                        resolve(window.knowledgeQueryAuthManager);
                        return;
                    }
                    
                    const checkInterval = setInterval(() => {
                        if (window.knowledgeQueryAuthManager) {
                            clearInterval(checkInterval);
                            resolve(window.knowledgeQueryAuthManager);
                        }
                    }, 100);
                    
                    // æœ€å¤§5ç§’å¾…æ©Ÿ
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve(null);
                    }, 5000);
                });
            }
            
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒã‚§ãƒƒã‚¯ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦auth.jsã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã¤ï¼‰
            setTimeout(() => {
                checkAuthentication();
            }, 500);
        })();
    </script>
</head>
<body>
    <!-- Header Navigation -->
    <header class="app-header">
        <div class="header-content">
            <h1 class="header-title">ç”ŸæŠ€ãƒŠãƒ¬ãƒƒã‚¸AI</h1>
            <nav class="header-nav">
                <button class="btn-settings" id="openSettingsBtn" title="è¨­å®š">
                    âš™ï¸
                </button>
                <button class="btn-search-target" id="openSearchTargetBtn">
                    ğŸ¯ æ¤œç´¢å¯¾è±¡é¸æŠ
                </button>
                <!-- Current Search Target Display -->
                <div class="current-search-target">
                    <div class="search-target-info">
                        <span class="label">ğŸ“ æ¤œç´¢å¯¾è±¡:</span>
                        <span id="currentFolderDisplay" class="folder-display">æœªé¸æŠ</span>
                    </div>
                </div>
                <button class="nav-tab active" data-page="pdf-processing">
                    ğŸ“„ æŠ€è¡“è³‡æ–™ã®ãƒŠãƒ¬ãƒƒã‚¸åŒ–
                </button>
                <button class="nav-tab" data-page="knowledge-query">
                    ğŸ” AIè³ªå•
                </button>
                <button class="nav-tab" data-page="verification-plan">
                    ğŸ“‹ æ¤œè¨¼è¨ˆç”»
                </button>
                <button class="nav-tab" data-page="specification">
                    ğŸ“– ä»•æ§˜æ›¸
                </button>
                <button class="nav-tab" data-page="prompt-management">
                    âš™ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
                </button>
                <button id="logoutBtn" class="btn btn-secondary btn-small">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </nav>
        </div>
    </header>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ è¨­å®š</h2>
                <button class="modal-close" id="closeSettingsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h3>ğŸ¤– AI ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®š</h3>
                    <p class="section-description">Bedrock Agentã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚ˆã‚Šé«˜åº¦ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ï¼‰</p>
                    
                    <div class="toggle-container">
                        <label class="toggle-label">
                            <input type="checkbox" id="useAgentToggle" class="toggle-input">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">
                                <span class="toggle-text-on">Agentã‚’åˆ©ç”¨ã™ã‚‹ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</span>
                                <span class="toggle-text-off">Agentã‚’åˆ©ç”¨ã—ãªã„</span>
                            </span>
                        </label>
                    </div>
                    
                    <div class="setting-info">
                        <p><strong>Agentåˆ©ç”¨æ™‚:</strong> ã‚ˆã‚Šé«˜åº¦ãªæ¨è«–ã¨ä¼šè©±ã®æ–‡è„ˆç†è§£ãŒå¯èƒ½</p>
                        <p><strong>Agentéåˆ©ç”¨æ™‚:</strong> å¾“æ¥ã®Knowledgebaseç›´æ¥æ¤œç´¢ã‚’ä½¿ç”¨</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveSettingsBtn" class="btn btn-primary btn-large">ä¿å­˜</button>
                <button id="cancelSettingsBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <!-- Search Target Selection Modal -->
    <div id="searchTargetModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ¯ æ¤œç´¢å¯¾è±¡é¸æŠ</h2>
                <button class="modal-close" id="closeSearchTargetBtn">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Folder Path Selection (Required) -->
                <div class="form-section">
                    <h3>ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ <span class="required-badge">å¿…é ˆ</span></h3>
                    <p class="section-description">æ¤œç´¢ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</p>
                    
                    <div id="folderTreeContainer" class="folder-tree-modal">
                        <p class="placeholder-text">ãƒ•ã‚©ãƒ«ãƒ€ãƒ„ãƒªãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    
                    <div id="selectedFoldersDisplay" class="selected-folders">
                        <strong>é¸æŠä¸­ã®ãƒ•ã‚©ãƒ«ãƒ€:</strong>
                        <div id="selectedFolderTags" class="folder-tags">
                            <span class="no-selection">æœªé¸æŠ</span>
                        </div>
                    </div>
                </div>
                
                <!-- Job ID Selection (Optional) -->
                <div class="form-section">
                    <h3>ğŸ”‘ JOB_ID <span class="optional-badge">é–‹ç™ºè€…ç”¨</span></h3>
                    <input 
                        type="text" 
                        id="jobIdInputModal" 
                        class="form-control" 
                        placeholder="ç‰¹å®šã®JOB_IDã§æ¤œç´¢ã™ã‚‹å ´åˆã®ã¿å…¥åŠ›"
                    />
                </div>
            </div>
            <div class="modal-footer">
                <button id="applySearchTargetBtn" class="btn btn-primary btn-large">é©ç”¨</button>
                <button id="startFromHistoryBtn" class="btn btn-secondary">ğŸ“‹ å±¥æ­´ã‹ã‚‰å§‹ã‚ã‚‹</button>
                <button id="cancelSearchTargetBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    <div class="container">
        <!-- Header will be added by header script -->
        <div id="headerContainer"></div>

        <!-- Main Content: Sidebar + Chat + PDF Viewer -->
        <div class="knowledge-query-container">
            <!-- Sidebar: Chat History -->
            <aside class="history-sidebar collapsed" id="historySidebar">
                <div class="sidebar-header">
                    <h3>ğŸ“‹ å±¥æ­´</h3>
                    <!-- Sidebar Toggle Button (Inside header) -->
                    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å±•é–‹">ï¼</button>
                </div>
                
                <!-- Sidebar Controls -->
                <div class="sidebar-controls">
                    <button id="refreshHistoryBtn" class="btn btn-small btn-refresh" title="å±¥æ­´ã‚’æ›´æ–°">ğŸ”„ æ›´æ–°</button>
                </div>
                
                <!-- Search Box -->
                <div class="search-box">
                    <input 
                        type="text" 
                        id="historySearchInput" 
                        class="search-input" 
                        placeholder="å±¥æ­´ã‚’æ¤œç´¢..."
                    />
                    <button id="historySearchBtn" class="btn btn-small btn-search">ğŸ”</button>
                </div>
                
                <!-- History List -->
                <div id="historyList" class="history-list">
                    <div class="empty-message">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </aside>

            <!-- Main Content: Chat + PDF -->
            <div class="main-content">
            <!-- Left Side: Chat -->
            <div class="chat-section">
                <h2>AIã¸ã®è³ªå•</h2>
                
                
                <!-- Chat History -->
                <div id="chatHistory" class="chat-history">
                    <div class="chat-message system-message">
                        <p>æ¤œç´¢å¯¾è±¡ã‚’ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>

                <!-- Template Selector -->
                <div class="template-selector-bar" id="templateSelectorBar">
                    <div class="template-selector-row">
                        <label for="promptTemplateSelect">ğŸ“ å‡ºåŠ›ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</label>
                        <select id="promptTemplateSelect" class="template-select">
                            <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
                        </select>
                        <button id="insertTemplateBtn" class="btn btn-small btn-accent" title="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›æ¬„ã«æŒ¿å…¥">æŒ¿å…¥</button>
                        <a href="prompt-management.html" class="btn btn-small btn-secondary" title="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†">âš™ï¸ ç®¡ç†</a>
                    </div>
                </div>

                <!-- Query Input Form -->
                <div class="query-form">
                    <textarea 
                        id="queryInput" 
                        class="query-input" 
                        placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                        rows="3"
                        disabled
                    ></textarea>
                    <div class="button-group">
                        <button id="submitQueryBtn" class="btn btn-primary">é€ä¿¡</button>
                        <button id="resetChatBtn" class="btn btn-secondary">ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <p id="queryStatus" class="status-message" style="display: none;"></p>
                </div>
            </div>

            <!-- Resize Bar -->
            <div class="resize-bar" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å¹…ã‚’èª¿æ•´"></div>

            <!-- Right Side: PDF Viewer -->
            <div class="pdf-section">
                <h2>è³‡æ–™</h2>
                
                <!-- PDF Selector -->
                <div id="pdfSelectorContainer" class="pdf-selector" style="display: none;">
                    <div class="pdf-nav">
                        <button id="prevPdfBtn" class="btn btn-small">â—€ å‰ã¸</button>
                        <span id="pdfIndicator" class="pdf-indicator"></span>
                        <button id="nextPdfBtn" class="btn btn-small">æ¬¡ã¸ â–¶</button>
                    </div>
                </div>

                <!-- PDF Canvas Area -->
                <div id="pdfViewerContainer" class="pdf-viewer"></div>

                <!-- PDF Page Controls -->
                <div id="pdfControls" class="pdf-controls" style="display: none;">
                    <div class="page-controls">
                        <button id="prevPageBtn" class="btn btn-small">å‰ãƒšãƒ¼ã‚¸</button>
                        <span id="pageIndicator" class="page-indicator"></span>
                        <button id="nextPageBtn" class="btn btn-small">æ¬¡ãƒšãƒ¼ã‚¸</button>
                    </div>
                    <div class="zoom-controls">
                        <button id="zoomInBtn" class="btn btn-small">ğŸ”+</button>
                        <button id="zoomOutBtn" class="btn btn-small">ğŸ”-</button>
                        <button id="resetZoomBtn" class="btn btn-small">ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Application Scripts -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Initialize auth manager for knowledge-query page (lightweight, no UI)
        let authManager = null;
        if (window.API_CONFIG?.cognitoUserPoolId && window.API_CONFIG?.cognitoClientId) {
            authManager = initializeAuthManager(
                window.API_CONFIG.cognitoUserPoolId,
                window.API_CONFIG.cognitoClientId,
                window.API_CONFIG.region || 'ap-northeast-1'
            );
            
            // Make it globally available for knowledge-query.js
            window.knowledgeQueryAuthManager = authManager;
        } else {
            console.warn('[knowledge-query.html] Cognito config not available yet, will initialize later');
        }
    </script>
    <script src="knowledge-query.js"></script>
    <script>
        // Simple navigation for knowledge-query.html page
        document.querySelectorAll('.nav-tab').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const page = button.getAttribute('data-page');
                if (page === 'index') {
                    window.location.href = 'index.html';
                } else if (page === 'knowledge-query') {
                    // Already on this page, do nothing
                    console.log('Already on knowledge-query page');
                } else if (page === 'verification-plan') {
                    window.location.href = 'verification-plan.html';
                } else if (page === 'specification') {
                    window.location.href = 'specification.html';
                }
            });
        });
    </script>
</body>
</html>
